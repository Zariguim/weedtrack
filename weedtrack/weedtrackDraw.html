<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Weedtrack Draw - Ferramenta de Mapeamento</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet.js (Mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet.draw (Ferramentas de Desenho) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Evita scroll da página inteira */
        }
        
        /* Garante que o painel tenha uma barra de rolagem bonita */
        #controls-panel::-webkit-scrollbar {
            width: 6px;
        }
        #controls-panel::-webkit-scrollbar-track {
            background: #f1f5f9; /* bg-slate-100 */
        }
        #controls-panel::-webkit-scrollbar-thumb {
            background: #94a3b8; /* bg-slate-400 */
            border-radius: 10px;
        }
        #controls-panel::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* bg-slate-500 */
        }

        /* O mapa deve ocupar todo o espaço disponível */
        #map {
            height: 100%;
            width: 100%;
            background-color: #e2e8f0; /* bg-slate-200 */
        }
        
        /* Animação para o painel lateral */
        #controls-panel {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Animação para o spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-fast {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Estrutura principal da aplicação -->
    <div id="app-container" class="relative h-screen w-screen flex">

        <!-- Painel de Controles Lateral (Sidebar) -->
        <aside id="controls-panel" class="absolute md:relative top-0 left-0 h-full bg-white p-4 shadow-lg flex flex-col gap-6 z-[1001] w-80 sm:w-96 transform md:translate-x-0 -translate-x-full">
            <!-- Cabeçalho do Painel -->
            <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                <h1 class="text-xl font-bold text-slate-800">Weedtrack Draw</h1>
                <button id="menu-close-btn" class="md:hidden text-slate-500 hover:text-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <!-- Seção de Instruções -->
            <div>
                <h2 class="font-bold text-lg mb-2">Como Usar</h2>
                <ul class="list-disc list-inside text-slate-600 space-y-1 text-sm">
                    <li>Use a ferramenta de polígono (<img src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/images/spritesheet.png" style="height:18px; width:18px; object-fit: none; object-position: -31px -1px; display: inline-block; vertical-align: middle;">) para desenhar no mapa.</li>
                    <li>Clique no mapa para adicionar pontos.</li>
                    <li>Clique no primeiro ponto para fechar o polígono.</li>
                    <li>A área será calculada automaticamente.</li>
                </ul>
            </div>

            <!-- Seção de Informações do Polígono -->
            <div id="info-container" class="flex flex-col gap-4 p-4 bg-slate-50 rounded-lg">
                 <h2 class="font-bold text-lg">Informações da Área</h2>
                 <div class="text-center">
                     <p class="text-slate-500 text-sm">Área Calculada</p>
                     <p id="area-display" class="text-3xl font-bold text-blue-600">0.00 ha</p>
                 </div>
            </div>

            <!-- Botão de Salvar/Usar -->
            <div id="download-container" class="mt-auto">
                 <button id="saveBtn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition flex items-center justify-center gap-2 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>
                     Usar este Polígono
                 </button>
            </div>
        </aside>

        <!-- Área Principal (Mapa) -->
        <main class="flex-grow h-full flex flex-col bg-slate-200">
            <button id="menu-toggle-btn" class="absolute top-2 left-2 md:hidden p-2 rounded-md text-slate-600 bg-white/50 hover:bg-white/90 backdrop-blur-sm z-[1000]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <div id="map"></div>
        </main>
    </div>

    <!-- Indicador de Carregamento -->
    <div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex flex-col items-center justify-center z-[2000]">
        <div class="animate-spin-fast rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
        <p id="loader-text" class="text-white mt-2 font-medium">Obtendo sua localização...</p>
    </div>

<script>
const App = {
    // --- ESTADO DA APLICAÇÃO ---
    map: null,
    drawnItems: null,
    lastPolygon: null,

    // --- ELEMENTOS DO DOM ---
    dom: {},

    // --- INICIALIZAÇÃO ---
    init() {
        this.dom = {
            controlsPanel: document.getElementById('controls-panel'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            menuCloseBtn: document.getElementById('menu-close-btn'),
            mapContainer: document.getElementById('map'),
            areaDisplay: document.getElementById('area-display'),
            saveBtn: document.getElementById('saveBtn'), // Atualizado de downloadBtn
            loader: document.getElementById('loader'),
        };

        this.bindEvents();
        this.initMap();
    },

    // --- VINCULAÇÃO DE EVENTOS ---
    bindEvents() {
        this.dom.menuToggleBtn.addEventListener('click', () => this.openPanel());
        this.dom.menuCloseBtn.addEventListener('click', () => this.closePanel());
        this.dom.saveBtn.addEventListener('click', () => this.sendKMLToParent()); // Atualizado
    },

    // --- LÓGICA DO MAPA ---
    initMap() {
        this.map = L.map(this.dom.mapContainer, {
            zoomControl: false 
        }).setView([-15.78, -47.92], 4);

        const hybridLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3'],
            attribution: 'Dados do mapa &copy;2024 Google'
        });
        this.map.addLayer(hybridLayer);

        L.control.zoom({ position: 'bottomright' }).addTo(this.map);
        
        this.drawnItems = new L.FeatureGroup();
        this.map.addLayer(this.drawnItems);

        this.initDrawControls();
        this.getUserLocation();
    },

    getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    this.map.setView([latitude, longitude], 16);
                    this.dom.loader.classList.add('hidden');
                },
                () => {
                    console.warn("Não foi possível obter a localização. Usando a visualização padrão.");
                    this.dom.loader.classList.add('hidden');
                }
            );
        } else {
            console.warn("Geolocalização não é suportada por este navegador.");
            this.dom.loader.classList.add('hidden');
        }
    },

    initDrawControls() {
        const drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                polygon: {
                    allowIntersection: false,
                    shapeOptions: {
                        color: '#3b82f6' // Azul
                    }
                },
                polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false
            },
            edit: {
                featureGroup: this.drawnItems,
                remove: true
            }
        });
        this.map.addControl(drawControl);

        this.map.on(L.Draw.Event.CREATED, (event) => {
            const layer = event.layer;
            this.drawnItems.clearLayers();
            this.drawnItems.addLayer(layer);
            this.lastPolygon = layer;
            this.calculateArea(layer);
            this.dom.saveBtn.disabled = false;
        });

        this.map.on(L.Draw.Event.EDITED, (event) => {
             const layers = event.layers;
             layers.eachLayer(layer => {
                 this.lastPolygon = layer;
                 this.calculateArea(layer);
             });
        });

        this.map.on(L.Draw.Event.DELETED, () => {
             this.lastPolygon = null;
             this.dom.areaDisplay.textContent = '0.00 ha';
             this.dom.saveBtn.disabled = true;
        });
    },

    calculateArea(layer) {
        const areaM2 = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        const areaHa = areaM2 / 10000;
        this.dom.areaDisplay.textContent = `${areaHa.toFixed(2)} ha`;
    },

    // --- LÓGICA DE EXPORTAÇÃO E COMUNICAÇÃO ---
    sendKMLToParent() {
        if (!this.lastPolygon) {
            alert("Por favor, desenhe um polígono primeiro.");
            return;
        }

        const latLngs = this.lastPolygon.getLatLngs()[0];
        const kmlCoords = [...latLngs, latLngs[0]]; 

        const coordinatesString = kmlCoords
            .map(p => `${p.lng},${p.lat},0`)
            .join(' ');

        const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Placemark>
    <name>Poligono Desenhado</name>
    <description>Área calculada: ${this.dom.areaDisplay.textContent}</description>
    <Polygon>
      <outerBoundaryIs>
        <LinearRing>
          <coordinates>${coordinatesString}</coordinates>
        </LinearRing>
      </outerBoundaryIs>
    </Polygon>
  </Placemark>
</kml>`;

        // Envia a string KML para a janela pai (Weedtrack Mapas)
        // O '*' permite a comunicação com qualquer origem, o que é seguro neste contexto de iframe.
        parent.postMessage({
            type: 'kmlDrawn',
            kmlString: kmlContent
        }, '*');
    },

    // --- CONTROLES DO PAINEL ---
    openPanel() {
        this.dom.controlsPanel.classList.remove('-translate-x-full');
    },

    closePanel() {
        this.dom.controlsPanel.classList.add('-translate-x-full');
    },
};

window.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
