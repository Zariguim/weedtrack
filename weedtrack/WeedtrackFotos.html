<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weedtrack - Classificação Aprimorada</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/piexifjs"></script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Evita scroll da página inteira */
        }
        
        /* Barra de rolagem personalizada para o painel de controles */
        #controls-panel::-webkit-scrollbar {
            width: 6px;
        }
        #controls-panel::-webkit-scrollbar-track {
            background: #f1f5f9; /* bg-slate-100 */
        }
        #controls-panel::-webkit-scrollbar-thumb {
            background: #94a3b8; /* bg-slate-400 */
            border-radius: 10px;
        }
        #controls-panel::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* bg-slate-500 */
        }

        /* Estilo para a imagem no visualizador */
        #currentImg {
            cursor: grab;
            user-select: none;
            transition: transform 0.1s ease-out;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #currentImg:active {
            cursor: grabbing;
        }

        /* Animação para o painel lateral */
        #controls-panel {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Animação de rotação para o loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-fast {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app-container" class="relative h-screen w-screen flex">

        <aside id="controls-panel" class="absolute md:relative top-0 left-0 h-full bg-white p-4 shadow-lg flex flex-col gap-4 z-30 w-80 sm:w-96 transform md:translate-x-0">
            <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                <h1 class="text-xl font-bold text-slate-800">Weedtrack Fotos</h1>
                <button id="menu-close-btn" class="md:hidden text-slate-500 hover:text-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div class="flex flex-col gap-2">
                 <button id="selectBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                    Selecionar Imagens
                </button>
                <p id="image-info" class="text-sm text-center text-slate-500">Nenhuma imagem carregada</p>
            </div>

            <div id="navigation-controls" class="hidden flex-col gap-4">
                <div class="flex justify-between items-center bg-slate-100 p-2 rounded-lg">
                    <button id="prevBtn" title="Imagem Anterior (Seta Esquerda)" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <p id="counter" class="font-mono font-semibold text-lg text-slate-700">0 / 0</p>
                    <button id="nextBtn" title="Próxima Imagem (Seta Direita)" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </div>

            <div id="weed-list-container" class="hidden flex-grow flex-col gap-2 overflow-y-auto pr-2">
                <div class="flex justify-between items-center">
                    <h2 class="font-bold">Classificação</h2>
                     <button id="addWeedBtn" class="text-sm bg-slate-200 text-slate-700 font-semibold py-1 px-3 rounded-md hover:bg-slate-300 transition">Adicionar</button>
                </div>
                <div id="weedList" class="flex flex-col gap-2"></div>
            </div>

            <div id="export-container" class="hidden">
                 <button id="exportBtn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
                    Exportar CSV
                </button>
            </div>
        </aside>

        <main class="flex-grow h-full flex flex-col bg-slate-200">
            <button id="menu-toggle-btn" class="absolute top-2 left-2 md:hidden p-2 rounded-md text-slate-600 bg-white/50 hover:bg-white/90 backdrop-blur-sm z-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            
            <div id="frame" class="w-full h-full relative overflow-hidden">
                <img id="currentImg" class="absolute top-1/2 left-1/2" alt="Selecione uma pasta de imagens para começar">
            </div>
        </main>
    </div>

    <div id="loader" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex flex-col items-center justify-center z-50">
        <div class="animate-spin-fast rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
        <p id="loader-text" class="text-white mt-2 font-medium"></p>
    </div>

    <div id="toast" class="hidden fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl z-50 transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>
    
    <div id="addWeedModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
            <h2 class="text-xl font-bold mb-4">Adicionar Nova Planta Daninha</h2>
            <div class="space-y-4">
                <div>
                    <label for="newWeedName" class="block text-sm font-medium text-gray-700">Nome da Planta</label>
                    <input type="text" id="newWeedName" placeholder="Ex: Capim-braquiária" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex gap-4">
                    <button id="confirmAddWeedBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Adicionar</button>
                    <button id="cancelAddWeedBtn" class="w-full bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

<script>
// Encapsulando toda a lógica em um objeto para melhor organização
const App = {
    // --- ESTADO DA APLICAÇÃO ---
    weeds: ["Buva", "Amargoso", "Capim-pé-de-galinha"],
    images: [],
    records: [],
    currentIndex: 0,
    
    // Estado do Pan & Zoom
    scale: 1,
    originX: 0,
    originY: 0,
    isPanning: false,
    panStartX: 0,
    panStartY: 0,

    // --- ELEMENTOS DO DOM ---
    dom: {},

    // --- INICIALIZAÇÃO ---
    init() {
        // Mapeia os elementos do DOM para o objeto `dom`
        this.dom = {
            controlsPanel: document.getElementById('controls-panel'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            menuCloseBtn: document.getElementById('menu-close-btn'),
            selectBtn: document.getElementById('selectBtn'),
            addWeedBtn: document.getElementById('addWeedBtn'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            exportBtn: document.getElementById('exportBtn'),
            img: document.getElementById('currentImg'),
            frame: document.getElementById('frame'),
            counter: document.getElementById('counter'),
            imageInfo: document.getElementById('image-info'),
            weedList: document.getElementById('weedList'),
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loader-text'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            addWeedModal: document.getElementById('addWeedModal'),
            newWeedNameInput: document.getElementById('newWeedName'),
            confirmAddWeedBtn: document.getElementById('confirmAddWeedBtn'),
            cancelAddWeedBtn: document.getElementById('cancelAddWeedBtn'),
            navigationControls: document.getElementById('navigation-controls'),
            weedListContainer: document.getElementById('weed-list-container'),
            exportContainer: document.getElementById('export-container'),
        };

        this.loadWeedsFromStorage(); 
        this.bindEvents();
        this.updateUIState();
    },

    // --- VINCULAÇÃO DE EVENTOS ---
    bindEvents() {
        // Controles do painel
        this.dom.menuToggleBtn.addEventListener('click', () => this.openPanel());
        this.dom.menuCloseBtn.addEventListener('click', () => this.closePanel());

        // Botões principais
        this.dom.selectBtn.addEventListener('click', () => this.selectImages());
        this.dom.addWeedBtn.addEventListener('click', () => this.openAddWeedModal());
        this.dom.exportBtn.addEventListener('click', () => this.exportCSV());

        // Navegação de imagens
        this.dom.prevBtn.addEventListener('click', () => this.changeImage(-1));
        this.dom.nextBtn.addEventListener('click', () => this.changeImage(1));
        
        // Modal
        this.dom.confirmAddWeedBtn.addEventListener('click', () => this.confirmAddWeed());
        this.dom.cancelAddWeedBtn.addEventListener('click', () => this.closeAddWeedModal());
        this.dom.newWeedNameInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') this.confirmAddWeed();
        });

        // Eventos de Pan & Zoom
        this.dom.frame.addEventListener('wheel', (e) => this.handleZoom(e));
        this.dom.frame.addEventListener('mousedown', (e) => this.startPan(e));
        window.addEventListener('mousemove', (e) => this.pan(e));
        window.addEventListener('mouseup', () => this.endPan());
        
        // Atalhos de teclado
        window.addEventListener('keydown', (e) => this.handleKeyDown(e));
    },
    
    // --- LÓGICA DA INTERFACE (UI/UX) ---
    
    setLoading(isLoading, text = '') {
        this.dom.loaderText.textContent = text;
        this.dom.loader.classList.toggle('hidden', !isLoading);
    },

    showToast(message, type = 'success', duration = 3000) {
        this.dom.toastMessage.textContent = message;
        this.dom.toast.classList.remove('bg-red-600', 'bg-green-600', 'bg-blue-600');
        
        const color = type === 'error' ? 'bg-red-600' : (type === 'info' ? 'bg-blue-600' : 'bg-green-600');
        this.dom.toast.classList.add(color);

        this.dom.toast.classList.remove('hidden');
        setTimeout(() => { this.dom.toast.classList.add('hidden'); }, duration);
    },

    openPanel() {
        this.dom.controlsPanel.classList.remove('-translate-x-full');
    },

    closePanel() {
        this.dom.controlsPanel.classList.add('-translate-x-full');
    },
    
    updateUIState() {
        const hasImages = this.images.length > 0;
        this.dom.navigationControls.classList.toggle('hidden', !hasImages);
        this.dom.weedListContainer.classList.toggle('hidden', !hasImages);
        this.dom.exportContainer.classList.toggle('hidden', !hasImages);
        
        if (hasImages) {
            this.dom.counter.textContent = `${this.currentIndex + 1} / ${this.images.length}`;
            this.dom.imageInfo.textContent = this.images[this.currentIndex].name;
            this.dom.prevBtn.disabled = this.currentIndex === 0;
            this.dom.nextBtn.disabled = this.currentIndex === this.images.length - 1;
        } else {
            this.dom.imageInfo.textContent = 'Nenhuma imagem carregada';
            this.dom.img.src = '';
            this.dom.img.alt = 'Selecione uma pasta de imagens para começar';
        }
    },

    // --- LÓGICA DE CLASSIFICAÇÃO E PERSISTÊNCIA ---

    loadWeedsFromStorage() {
        const savedWeeds = localStorage.getItem('weedtrack_weeds');
        if (savedWeeds) {
            try {
                this.weeds = JSON.parse(savedWeeds);
            } catch (e) {
                console.error("Erro ao carregar lista de plantas do localStorage:", e);
            }
        }
    },

    saveWeedsToStorage() {
        localStorage.setItem('weedtrack_weeds', JSON.stringify(this.weeds));
    },

    renderWeedList() {
        this.dom.weedList.innerHTML = '';
        this.weeds.forEach(name => {
            const id = name.replace(/\s+/g, '_');
            const div = document.createElement('div');
            div.className = 'bg-slate-50 p-3 rounded-lg flex justify-between items-center';
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <button data-action="delete" title="Remover ${name}" class="text-slate-400 hover:text-red-500 p-1 rounded-full hover:bg-red-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <label for="num_${id}" class="font-medium text-slate-700">${name}</label>
                </div>
                <div class="flex items-center gap-2">
                    <button data-action="decrement" class="w-7 h-7 rounded-md bg-slate-200 text-slate-600 font-bold text-lg flex items-center justify-center hover:bg-slate-300">-</button>
                    <input type="number" id="num_${id}" value="0" min="0" class="w-16 p-1 border border-slate-300 rounded-md text-center font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <button data-action="increment" class="w-7 h-7 rounded-md bg-slate-200 text-slate-600 font-bold text-lg flex items-center justify-center hover:bg-slate-300">+</button>
                </div>
            `;
            this.dom.weedList.appendChild(div);
            
            // Adiciona eventos aos botões de ação
            div.querySelector('[data-action="delete"]').addEventListener('click', () => this.deleteWeed(name));
            div.querySelector('[data-action="decrement"]').addEventListener('click', (e) => {
                const input = e.currentTarget.nextElementSibling;
                input.value = Math.max(0, (parseInt(input.value) || 0) - 1);
            });
            div.querySelector('[data-action="increment"]').addEventListener('click', (e) => {
                const input = e.currentTarget.previousElementSibling;
                input.value = (parseInt(input.value) || 0) + 1;
            });
        });
    },
    
    openAddWeedModal() {
        this.dom.addWeedModal.classList.remove('hidden');
        this.dom.newWeedNameInput.focus();
    },

    closeAddWeedModal() {
        this.dom.addWeedModal.classList.add('hidden');
        this.dom.newWeedNameInput.value = '';
    },

    confirmAddWeed() {
        const originalName = this.dom.newWeedNameInput.value.trim();
        if (!originalName) {
            this.showToast('O nome não pode estar vazio.', 'error');
            return;
        }

        const formattedName = originalName.replace(/\s+/g, '-');

        if (!this.weeds.find(w => w.toLowerCase() === formattedName.toLowerCase())) {
            this.saveCurrentRecord();
            this.weeds.unshift(formattedName);
            this.saveWeedsToStorage(); 
            this.renderWeedList();
            this.loadRecordForCurrentImage();
            this.showToast(`'${formattedName}' adicionado com sucesso!`, 'success');
        } else {
            this.showToast(`'${formattedName}' já existe na lista.`, 'info');
        }
        this.closeAddWeedModal();
    },

    deleteWeed(weedNameToDelete) {
        this.saveCurrentRecord(); 
        this.weeds = this.weeds.filter(w => w !== weedNameToDelete);
        this.saveWeedsToStorage();
        this.renderWeedList();
        this.loadRecordForCurrentImage(); 
        this.showToast(`'${weedNameToDelete}' foi removido.`, 'info');
    },
    
    saveCurrentRecord() {
        if (!this.images.length) return;
        if (!this.records[this.currentIndex]) {
             this.records[this.currentIndex] = { filename: this.images[this.currentIndex].name, weeds: {} };
        }
        const record = this.records[this.currentIndex];
        
        this.weeds.forEach(w => {
            const input = document.getElementById(`num_${w.replace(/\s+/g, '_')}`);
            if (input) {
                record.weeds[w] = parseInt(input.value) || 0;
            }
        });
        this.records[this.currentIndex] = record;
    },

    loadRecordForCurrentImage() {
        if (!this.images.length) return;
        this.weeds.forEach(w => {
            const el = document.getElementById(`num_${w.replace(/\s+/g, '_')}`);
            if (el) el.value = 0;
        });

        const record = this.records[this.currentIndex];
        if (record && record.weeds) {
            Object.entries(record.weeds).forEach(([weedName, value]) => {
                const el = document.getElementById(`num_${weedName.replace(/\s+/g, '_')}`);
                if (el) el.value = value;
            });
        }
    },

    // --- LÓGICA DE IMAGENS ---

    selectImages() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/jpeg, image/jpg';
        input.multiple = true;
        input.style.display = 'none'; // Garante que o input não seja visível

        input.onchange = (e) => {
            if (e.target.files.length > 0) {
                this.images = Array.from(e.target.files);
                this.records = new Array(this.images.length).fill(null);
                this.currentIndex = 0;
                this.displayImage();
            }
            // Limpa o input do DOM após o uso
            document.body.removeChild(input);
        };

        // Adiciona o input ao corpo do documento antes de clicar
        document.body.appendChild(input);
        input.click();
    },

    changeImage(direction) {
        this.saveCurrentRecord();
        const newIndex = this.currentIndex + direction;
        if (newIndex >= 0 && newIndex < this.images.length) {
            this.currentIndex = newIndex;
            this.displayImage();
        }
    },

    displayImage() {
        if (!this.images.length) {
            this.updateUIState();
            return;
        }
        
        this.setLoading(true, 'Carregando imagem e metadados...');
        this.renderWeedList();
        
        const file = this.images[this.currentIndex];
        
        this.dom.img.onload = () => {
            this.resetView(); 
            URL.revokeObjectURL(this.dom.img.src);
        };
        this.dom.img.src = URL.createObjectURL(file);
        
        const reader = new FileReader();
        reader.onload = (e) => {
            let lat = null, lon = null;
            try {
                const exif = piexif.load(e.target.result);
                const gps = exif.GPS;
                if (gps && gps[piexif.GPSIFD.GPSLatitude] && gps[piexif.GPSIFD.GPSLongitude]) {
                    lat = piexif.GPSHelper.dmsRationalToDeg(gps[piexif.GPSIFD.GPSLatitude], gps[piexif.GPSIFD.GPSLatitudeRef]);
                    lon = piexif.GPSHelper.dmsRationalToDeg(gps[piexif.GPSIFD.GPSLongitude], gps[piexif.GPSIFD.GPSLongitudeRef]);
                }
            } catch (error) {
                console.warn("Não foi possível ler os dados EXIF da imagem:", file.name, error);
            }

            if (!this.records[this.currentIndex]) {
                this.records[this.currentIndex] = { filename: file.name, latitude: lat, longitude: lon, weeds: {} };
            } else {
                this.records[this.currentIndex].latitude = lat;
                this.records[this.currentIndex].longitude = lon;
            }
            
            this.loadRecordForCurrentImage();
            this.updateUIState();
            this.setLoading(false);
        };
        reader.onerror = () => {
             this.showToast('Erro ao ler o arquivo de imagem.', 'error');
             this.setLoading(false);
        };
        reader.readAsDataURL(file);
    },

    // --- LÓGICA DE PAN & ZOOM ---
    updateTransform() {
        this.dom.img.style.transform = `translate(-50%, -50%) translate(${this.originX}px, ${this.originY}px) scale(${this.scale})`;
    },

    resetView() {
        this.scale = 1;
        this.originX = 0;
        this.originY = 0;
        this.updateTransform();
    },

    handleZoom(e) {
        e.preventDefault();
        const delta = -e.deltaY * 0.001;
        const newScale = Math.min(Math.max(0.2, this.scale + delta), 10);

        const rect = this.dom.img.getBoundingClientRect();
        const mouseX = e.clientX - rect.left - (rect.width / 2);
        const mouseY = e.clientY - rect.top - (rect.height / 2);

        this.originX -= (mouseX * (newScale - this.scale)) / this.scale;
        this.originY -= (mouseY * (newScale - this.scale)) / this.scale;
        
        this.scale = newScale;
        this.updateTransform();
    },

    startPan(e) {
        e.preventDefault();
        this.isPanning = true;
        this.panStartX = e.clientX - this.originX;
        this.panStartY = e.clientY - this.originY;
        this.dom.img.style.cursor = 'grabbing';
    },

    pan(e) {
        if (this.isPanning) {
            this.originX = e.clientX - this.panStartX;
            this.originY = e.clientY - this.panStartY;
            this.updateTransform();
        }
    },

    endPan() {
        if (this.isPanning) {
            this.isPanning = false;
            this.dom.img.style.cursor = 'grab';
        }
    },
    
    handleKeyDown(e) {
        if (document.activeElement.tagName === 'INPUT' || !this.images.length) return;

        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'ArrowLeft') {
                this.changeImage(-1);
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                this.changeImage(1);
                e.preventDefault();
            }
            return;
        }

        const panStep = 20;
        let keyHandled = false;
        switch(e.key) {
            case 'ArrowLeft':  this.originX += panStep; keyHandled = true; break;
            case 'ArrowRight': this.originX -= panStep; keyHandled = true; break;
            case 'ArrowUp':    this.originY += panStep; keyHandled = true; break;
            case 'ArrowDown':  this.originY -= panStep; keyHandled = true; break;
        }

        if (keyHandled) {
            e.preventDefault();
            this.updateTransform();
        }
    },

    // --- LÓGICA DE EXPORTAÇÃO ---
    exportCSV() {
        if (!this.images.length) {
            this.showToast('Nenhuma imagem para exportar.', 'error');
            return;
        }
        this.saveCurrentRecord();

        const classifiedRecords = this.records.filter(record => record !== null);

        if (classifiedRecords.length === 0) {
            this.showToast('Nenhuma imagem foi classificada ainda.', 'info');
            return;
        }

        const headers = ['latitude', 'longitude', ...this.weeds];
        const csvRows = [headers.join(',')];

        classifiedRecords.forEach(record => {
            const row = [
                record.latitude || '',
                record.longitude || '',
                ...this.weeds.map(w => (record.weeds && record.weeds[w]) || 0)
            ];
            csvRows.push(row.join(','));
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'Weedtrack_classificacao.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        this.showToast(`${classifiedRecords.length} registro(s) exportado(s) com sucesso!`, 'success');
    }
};

// Inicia a aplicação quando o DOM estiver pronto
window.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>